<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>protflow.tools.ligandmpnn &mdash; ProtFlow 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=8d563738"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ProtFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../protflow.html">protflow package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ProtFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">protflow.tools.ligandmpnn</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for protflow.tools.ligandmpnn</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">LigandMPNN Module</span>
<span class="sd">=================</span>

<span class="sd">This module provides the functionality to integrate LigandMPNN within the ProtFlow framework. It offers tools to run LigandMPNN, handle its inputs and outputs, and process the resulting data in a structured and automated manner.</span>

<span class="sd">Detailed Description</span>
<span class="sd">--------------------</span>
<span class="sd">The `LigandMPNN` class encapsulates the functionality necessary to execute LigandMPNN runs. It manages the configuration of paths to essential scripts and Python executables, sets up the environment, and handles the execution of the diffusion processes. It also includes methods for collecting and processing output data, ensuring that the results are organized and accessible for further analysis within the ProtFlow ecosystem.</span>

<span class="sd">The module is designed to streamline the integration of LigandMPNN into larger computational workflows. It supports the automatic setup of job parameters, execution of LigandMPNN commands, and parsing of output files into a structured DataFrame format. This facilitates subsequent data analysis and visualization steps.</span>

<span class="sd">Usage</span>
<span class="sd">-----</span>
<span class="sd">To use this module, create an instance of the `LigandMPNN` class and invoke its `run` method with appropriate parameters. The module will handle the configuration, execution, and result collection processes. Detailed control over the process is provided through various parameters, allowing for customized runs tailored to specific research needs.</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">Here is an example of how to initialize and use the `LigandMPNN` class within a ProtFlow pipeline:</span>

<span class="sd">.. code-block:: python</span>

<span class="sd">    from protflow.poses import Poses</span>
<span class="sd">    from protflow.jobstarters import JobStarter</span>
<span class="sd">    from ligandmpnn import LigandMPNN</span>

<span class="sd">    # Create instances of necessary classes</span>
<span class="sd">    poses = Poses()</span>
<span class="sd">    jobstarter = JobStarter()</span>

<span class="sd">    # Initialize the LigandMPNN class</span>
<span class="sd">    ligandmpnn = LigandMPNN()</span>

<span class="sd">    # Run the diffusion process</span>
<span class="sd">    results = ligandmpnn.run(</span>
<span class="sd">        poses=poses,</span>
<span class="sd">        prefix=&quot;experiment_1&quot;,</span>
<span class="sd">        jobstarter=jobstarter,</span>
<span class="sd">        nseq=10,</span>
<span class="sd">        model_type=&quot;ligand_mpnn&quot;,</span>
<span class="sd">        options=&quot;some_option=some_value&quot;,</span>
<span class="sd">        pose_options=[&quot;pose_option=pose_value&quot;],</span>
<span class="sd">        overwrite=True</span>
<span class="sd">    )</span>

<span class="sd">    # Access and process the results</span>
<span class="sd">    print(results)</span>

<span class="sd">Further Details</span>
<span class="sd">---------------</span>
<span class="sd">- Edge Cases: The module handles various edge cases, such as empty pose lists and the need to overwrite previous results. It ensures robust error handling and logging for easier debugging and verification of the process.</span>
<span class="sd">- Customizability: Users can customize the process through multiple parameters, including the number of sequences, specific options for the LigandMPNN script, and options for handling pose-specific parameters.</span>
<span class="sd">- Integration: The module seamlessly integrates with other components of the ProtFlow framework, leveraging shared configurations and data structures to provide a cohesive user experience.</span>

<span class="sd">This module is intended for researchers and developers who need to incorporate LigandMPNN into their protein design and analysis workflows. By automating many of the setup and execution steps, it allows users to focus on interpreting results and advancing their scientific inquiries.</span>

<span class="sd">Notes</span>
<span class="sd">-----</span>
<span class="sd">This module is part of the ProtFlow package and is designed to work in tandem with other components of the package, especially those related to job management in HPC environments.</span>

<span class="sd">Author</span>
<span class="sd">------</span>
<span class="sd">Markus Braun, Adrian Tripp</span>

<span class="sd">Version</span>
<span class="sd">-------</span>
<span class="sd">0.1.0</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># general imports</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1"># dependencies</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">Bio</span>
<span class="kn">import</span> <span class="nn">Bio.SeqIO</span>

<span class="c1"># custom</span>
<span class="kn">import</span> <span class="nn">protflow.config</span>
<span class="kn">from</span> <span class="nn">protflow.residues</span> <span class="kn">import</span> <span class="n">ResidueSelection</span>
<span class="kn">import</span> <span class="nn">protflow.tools</span>
<span class="kn">import</span> <span class="nn">protflow.runners</span>
<span class="kn">from</span> <span class="nn">protflow.poses</span> <span class="kn">import</span> <span class="n">Poses</span>
<span class="kn">from</span> <span class="nn">protflow.jobstarters</span> <span class="kn">import</span> <span class="n">JobStarter</span>
<span class="kn">from</span> <span class="nn">protflow.runners</span> <span class="kn">import</span> <span class="n">Runner</span><span class="p">,</span> <span class="n">RunnerOutput</span><span class="p">,</span> <span class="n">regex_expand_options_flags</span><span class="p">,</span> <span class="n">parse_generic_options</span><span class="p">,</span> <span class="n">col_in_df</span><span class="p">,</span> <span class="n">options_flags_to_string</span>


<span class="n">LIGANDMPNN_CHECKPOINT_DICT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;protein_mpnn&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/model_params/proteinmpnn_v_48_020.pt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ligand_mpnn&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/model_params/ligandmpnn_v_32_010_25.pt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;per_residue_label_membrane_mpnn&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/model_params/per_residue_label_membrane_mpnn_v_48_020.pt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;global_label_membrane_mpnn&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/model_params/global_label_membrane_mpnn_v_48_020.pt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;soluble_mpnn&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;/model_params/solublempnn_v_48_020.pt&quot;</span>
<span class="p">}</span>

<div class="viewcode-block" id="LigandMPNN">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN">[docs]</a>
<span class="k">class</span> <span class="nc">LigandMPNN</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LigandMPNN Class</span>
<span class="sd">    ================</span>

<span class="sd">    The `LigandMPNN` class provides the necessary methods to execute LigandMPNN runs within the ProtFlow framework. This class is responsible for managing the configuration, execution, and output processing of LigandMPNN tasks.</span>

<span class="sd">    Detailed Description</span>
<span class="sd">    --------------------</span>
<span class="sd">    The `LigandMPNN` class integrates LigandMPNN into the ProtFlow pipeline by setting up the environment, running the diffusion process, and collecting the results. It ensures that the inputs and outputs are handled efficiently, making the data readily available for further analysis.</span>

<span class="sd">    Key Features:</span>
<span class="sd">    - Manages paths to essential scripts and executables.</span>
<span class="sd">    - Configures and executes LigandMPNN processes.</span>
<span class="sd">    - Collects and processes output data into a structured DataFrame format.</span>
<span class="sd">    - Handles various edge cases and supports custom configurations through multiple parameters.</span>

<span class="sd">    Usage</span>
<span class="sd">    -----</span>
<span class="sd">    To use this class, initialize it with the appropriate script and Python paths, along with an optional job starter. The main functionality is provided through the `run` method, which requires parameters such as poses, prefix, and additional options for customization.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    .. code-block:: python</span>

<span class="sd">        from protflow.poses import Poses</span>
<span class="sd">        from protflow.jobstarters import JobStarter</span>
<span class="sd">        from ligandmpnn import LigandMPNN</span>

<span class="sd">        # Create instances of necessary classes</span>
<span class="sd">        poses = Poses()</span>
<span class="sd">        jobstarter = JobStarter()</span>

<span class="sd">        # Initialize the LigandMPNN class</span>
<span class="sd">        ligandmpnn = LigandMPNN()</span>

<span class="sd">        # Run the diffusion process</span>
<span class="sd">        results = ligandmpnn.run(</span>
<span class="sd">            poses=poses,</span>
<span class="sd">            prefix=&quot;experiment_1&quot;,</span>
<span class="sd">            jobstarter=jobstarter,</span>
<span class="sd">            nseq=10,</span>
<span class="sd">            model_type=&quot;ligand_mpnn&quot;,</span>
<span class="sd">            options=&quot;some_option=some_value&quot;,</span>
<span class="sd">            pose_options=[&quot;pose_option=pose_value&quot;],</span>
<span class="sd">            overwrite=True</span>
<span class="sd">        )</span>

<span class="sd">        # Access and process the results</span>
<span class="sd">        print(results)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This class is designed to work within the ProtFlow framework and assumes that the necessary configurations and dependencies are properly set up. It leverages shared data structures and configurations from ProtFlow to provide a seamless integration experience.</span>

<span class="sd">    Author</span>
<span class="sd">    ------</span>
<span class="sd">    Markus Braun, Adrian Tripp</span>

<span class="sd">    Version</span>
<span class="sd">    -------</span>
<span class="sd">    0.1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="LigandMPNN.__init__">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_path</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="n">protflow</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LIGANDMPNN_SCRIPT_PATH</span><span class="p">,</span> <span class="n">python_path</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="n">protflow</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LIGANDMPNN_PYTHON_PATH</span><span class="p">,</span> <span class="n">jobstarter</span><span class="p">:</span><span class="n">JobStarter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the LigandMPNN class.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            script_path (str, optional): The path to the LigandMPNN script. Defaults to the configured script path in ProtFlow.</span>
<span class="sd">            python_path (str, optional): The path to the Python executable to run the LigandMPNN script. Defaults to the configured Python path in ProtFlow.</span>
<span class="sd">            jobstarter (JobStarter, optional): An instance of the JobStarter class to manage job submissions. If not provided, it will use the default job starter configuration.</span>

<span class="sd">        Detailed Description</span>
<span class="sd">        --------------------</span>
<span class="sd">        The `__init__` method sets up the necessary paths and configurations for running LigandMPNN. It searches for the provided script and Python</span>
<span class="sd">        paths to ensure they are correct and sets them as instance attributes. Additionally, it initializes the job starter, which manages the execution</span>
<span class="sd">        of jobs in high-performance computing (HPC) environments. This method ensures that all configurations are correctly set up before running any</span>
<span class="sd">        LigandMPNN tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">script_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_path</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;LIGANDMPNN_SCRIPT_PATH&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">python_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_path</span><span class="p">(</span><span class="n">python_path</span><span class="p">,</span> <span class="s2">&quot;LIGANDMPNN_PYTHON_PATH&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;ligandmpnn.py&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_layers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobstarter</span> <span class="o">=</span> <span class="n">jobstarter</span></div>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;ligandmpnn.py&quot;</span>

<div class="viewcode-block" id="LigandMPNN.run">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.run">[docs]</a>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poses</span><span class="p">:</span> <span class="n">Poses</span><span class="p">,</span> <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">jobstarter</span><span class="p">:</span> <span class="n">JobStarter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nseq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">model_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_options</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fixed_res_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">design_res_col</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pose_opt_cols</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_seq_threaded_pdbs_as_pose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">preserve_original_output</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Poses</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute the LigandMPNN process with given poses and jobstarter configuration.</span>

<span class="sd">        This method sets up and runs the LigandMPNN process using the provided poses and jobstarter object. It handles the configuration, execution, and collection of output data, ensuring that the results are organized and accessible for further analysis.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            poses (Poses): The Poses object containing the protein structures.</span>
<span class="sd">            prefix (str): A prefix used to name and organize the output files.</span>
<span class="sd">            jobstarter (JobStarter, optional): An instance of the JobStarter class, which manages job execution. Defaults to None.</span>
<span class="sd">            nseq (int, optional): The number of sequences to generate for each input pose. Defaults to None.</span>
<span class="sd">            model_type (str, optional): The type of model to use. Defaults to &#39;ligand_mpnn&#39;.</span>
<span class="sd">            options (str, optional): Additional options for the LigandMPNN script. Defaults to None.</span>
<span class="sd">            pose_options (object, optional): Pose-specific options for the LigandMPNN script. Defaults to None.</span>
<span class="sd">            fixed_res_col (str, optional): Column name in the poses DataFrame specifying fixed residues. Defaults to None.</span>
<span class="sd">            design_res_col (str, optional): Column name in the poses DataFrame specifying residues to be redesigned. Defaults to None.</span>
<span class="sd">            pose_opt_cols (dict, optional): Dictionary of pose-specific options for the LigandMPNN script. Defaults to None.</span>
<span class="sd">            return_seq_threaded_pdbs_as_pose (bool, optional): If True, return sequence-threaded PDBs as poses. Defaults to False.</span>
<span class="sd">            preserve_original_output (bool, optional): If True, preserve the original output files. Defaults to True.</span>
<span class="sd">            overwrite (bool, optional): If True, overwrite existing output files. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Poses: The updated Poses object containing the results of the LigandMPNN process.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If required files or directories are not found during the execution process.</span>
<span class="sd">            ValueError: If invalid arguments are provided to the method.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Here is an example of how to use the `run` method:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                from protflow.poses import Poses</span>
<span class="sd">                from protflow.jobstarters import JobStarter</span>
<span class="sd">                from ligandmpnn import LigandMPNN</span>

<span class="sd">                # Create instances of necessary classes</span>
<span class="sd">                poses = Poses()</span>
<span class="sd">                jobstarter = JobStarter()</span>

<span class="sd">                # Initialize the LigandMPNN class</span>
<span class="sd">                ligandmpnn = LigandMPNN()</span>

<span class="sd">                # Run the diffusion process</span>
<span class="sd">                results = ligandmpnn.run(</span>
<span class="sd">                    poses=poses,</span>
<span class="sd">                    prefix=&quot;experiment_1&quot;,</span>
<span class="sd">                    jobstarter=jobstarter,</span>
<span class="sd">                    nseq=10,</span>
<span class="sd">                    model_type=&quot;ligand_mpnn&quot;,</span>
<span class="sd">                    options=&quot;some_option=some_value&quot;,</span>
<span class="sd">                    pose_options=[&quot;pose_option=pose_value&quot;],</span>
<span class="sd">                    overwrite=True</span>
<span class="sd">                )</span>

<span class="sd">                # Access and process the results</span>
<span class="sd">                print(results)</span>

<span class="sd">        Further Details:</span>
<span class="sd">            - **Setup and Execution:** The method ensures that the environment is correctly set up, directories are prepared, and necessary commands are constructed and executed.</span>
<span class="sd">            - **Output Management:** The method handles the collection and processing of output data, ensuring that results are organized and accessible for further analysis.</span>
<span class="sd">            - **Customization:** Extensive customization options are provided through parameters, allowing users to tailor the process to their specific needs.</span>

<span class="sd">        This method is designed to streamline the execution of LigandMPNN processes within the ProtFlow framework, making it easier for researchers and developers to perform and analyze protein design simulations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># run in batch mode if pose_options are not set:</span>
        <span class="n">pose_opt_cols</span> <span class="o">=</span> <span class="n">pose_opt_cols</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">run_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_batch_run</span><span class="p">(</span><span class="n">pose_options</span><span class="p">,</span> <span class="n">pose_opt_cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">run_batch</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting up ligandmpnn for batched design.&quot;</span><span class="p">)</span>

        <span class="c1"># setup runner</span>
        <span class="n">work_dir</span><span class="p">,</span> <span class="n">jobstarter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generic_run_setup</span><span class="p">(</span>
            <span class="n">poses</span><span class="o">=</span><span class="n">poses</span><span class="p">,</span>
            <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
            <span class="n">jobstarters</span><span class="o">=</span><span class="p">[</span><span class="n">jobstarter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobstarter</span><span class="p">,</span> <span class="n">poses</span><span class="o">.</span><span class="n">default_jobstarter</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Look for output-file in pdb-dir. If output is present and correct, skip LigandMPNN.</span>
        <span class="n">scorefile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ligandmpnn_scores.</span><span class="si">{</span><span class="n">poses</span><span class="o">.</span><span class="n">storage_format</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scores</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_for_existing_scorefile</span><span class="p">(</span><span class="n">scorefile</span><span class="o">=</span><span class="n">scorefile</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">RunnerOutput</span><span class="p">(</span><span class="n">poses</span><span class="o">=</span><span class="n">poses</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">scores</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">index_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_layers</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">return_poses</span><span class="p">()</span>

        <span class="c1"># integrate redesigned and fixed residue parameters into pose_opt_cols:</span>
        <span class="k">if</span> <span class="n">fixed_res_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pose_opt_cols</span><span class="p">[</span><span class="s2">&quot;fixed_residues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fixed_res_col</span>
        <span class="k">if</span> <span class="n">design_res_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pose_opt_cols</span><span class="p">[</span><span class="s2">&quot;redesigned_residues&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">design_res_col</span>

        <span class="c1"># parse pose_opt_cols into pose_options format.</span>
        <span class="n">pose_opt_cols_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_pose_opt_cols</span><span class="p">(</span><span class="n">poses</span><span class="o">=</span><span class="n">poses</span><span class="p">,</span> <span class="n">pose_opt_cols</span><span class="o">=</span><span class="n">pose_opt_cols</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">)</span>

        <span class="c1"># parse pose_options</span>
        <span class="n">pose_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_pose_options</span><span class="p">(</span><span class="n">poses</span><span class="o">=</span><span class="n">poses</span><span class="p">,</span> <span class="n">pose_options</span><span class="o">=</span><span class="n">pose_options</span><span class="p">)</span>

        <span class="c1"># combine pose_options and pose_opt_cols_options (priority goes to pose_opt_cols_options):</span>
        <span class="n">pose_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">options_flags_to_string</span><span class="p">(</span><span class="o">*</span><span class="n">parse_generic_options</span><span class="p">(</span><span class="n">pose_opt</span><span class="p">,</span> <span class="n">pose_opt_cols_opt</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">pose_opt</span><span class="p">,</span> <span class="n">pose_opt_cols_opt</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pose_options</span><span class="p">,</span> <span class="n">pose_opt_cols_options</span><span class="p">)]</span>

        <span class="c1"># write ligandmpnn cmds:</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">write_cmd</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_type</span><span class="p">,</span> <span class="n">nseq</span><span class="o">=</span><span class="n">nseq</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">pose_options</span><span class="o">=</span><span class="n">pose_opts</span><span class="p">)</span> <span class="k">for</span> <span class="n">pose</span><span class="p">,</span> <span class="n">pose_opts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">poses</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;poses&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">pose_options</span><span class="p">)]</span>

        <span class="c1"># batch_run setup:</span>
        <span class="k">if</span> <span class="n">run_batch</span><span class="p">:</span>
            <span class="n">cmds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_batch_run</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">num_batches</span><span class="o">=</span><span class="n">jobstarter</span><span class="o">.</span><span class="n">max_cores</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">)</span>

        <span class="c1"># run</span>
        <span class="n">jobstarter</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
            <span class="n">cmds</span><span class="o">=</span><span class="n">cmds</span><span class="p">,</span>
            <span class="n">jobname</span><span class="o">=</span><span class="s2">&quot;ligandmpnn&quot;</span><span class="p">,</span>
            <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">output_path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="p">)</span>

        <span class="c1"># collect scores</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_scores</span><span class="p">(</span>
            <span class="n">work_dir</span><span class="o">=</span><span class="n">work_dir</span><span class="p">,</span>
            <span class="n">return_seq_threaded_pdbs_as_pose</span><span class="o">=</span><span class="n">return_seq_threaded_pdbs_as_pose</span><span class="p">,</span>
            <span class="n">preserve_original_output</span><span class="o">=</span><span class="n">preserve_original_output</span>
        <span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving scores of </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">scorefile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_runner_scorefile</span><span class="p">(</span><span class="n">scores</span><span class="o">=</span><span class="n">scores</span><span class="p">,</span> <span class="n">scorefile</span><span class="o">=</span><span class="n">scorefile</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">RunnerOutput</span><span class="p">(</span><span class="n">poses</span><span class="o">=</span><span class="n">poses</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">scores</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">index_layers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index_layers</span><span class="p">)</span><span class="o">.</span><span class="n">return_poses</span><span class="p">()</span></div>


<div class="viewcode-block" id="LigandMPNN.check_for_batch_run">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.check_for_batch_run">[docs]</a>
    <span class="k">def</span> <span class="nf">check_for_batch_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose_options</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pose_opt_cols</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if LigandMPNN can be run in batch mode.</span>

<span class="sd">        This method determines whether the LigandMPNN process can be executed in batch mode. It does this by checking if pose-specific options are not provided and if only multi-residue columns are specified in the pose options.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            pose_options (str): Pose-specific options for the LigandMPNN script.</span>
<span class="sd">            pose_opt_cols (dict): Dictionary of pose-specific options for the LigandMPNN script.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if LigandMPNN can be run in batch mode, False otherwise.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Here is an example of how to use the `check_for_batch_run` method:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                # Initialize the LigandMPNN class</span>
<span class="sd">                ligandmpnn = LigandMPNN()</span>

<span class="sd">                # Check for batch run</span>
<span class="sd">                can_batch_run = ligandmpnn.check_for_batch_run(</span>
<span class="sd">                    pose_options=None,</span>
<span class="sd">                    pose_opt_cols={&quot;fixed_residues&quot;: &quot;fixed_res_col&quot;}</span>
<span class="sd">                )</span>

<span class="sd">                print(can_batch_run)  # Outputs: True or False</span>

<span class="sd">        Further Details:</span>
<span class="sd">            - **Batch Mode Check:** The method checks if the `pose_options` is None and if the `pose_opt_cols` contains only multi-residue columns, which are necessary for batch processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pose_options</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_cols_only</span><span class="p">(</span><span class="n">pose_opt_cols</span><span class="p">)</span></div>


<div class="viewcode-block" id="LigandMPNN.multi_cols_only">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.multi_cols_only">[docs]</a>
    <span class="k">def</span> <span class="nf">multi_cols_only</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose_opt_cols</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;checks if only multi_res cols are in pose_opt_cols dict. Only _multi arguments can be used for ligandmpnn_batch runs.&#39;&#39;&#39;</span>
        <span class="n">multi_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;omit_AA_per_residue&quot;</span><span class="p">,</span> <span class="s2">&quot;bias_AA_per_residue&quot;</span><span class="p">,</span> <span class="s2">&quot;redesigned_residues&quot;</span><span class="p">,</span> <span class="s2">&quot;fixed_residues&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">pose_opt_cols</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">all</span><span class="p">((</span><span class="n">col</span> <span class="ow">in</span> <span class="n">multi_cols</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pose_opt_cols</span><span class="p">))</span></div>


<div class="viewcode-block" id="LigandMPNN.setup_batch_run">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.setup_batch_run">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_batch_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmds</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">num_batches</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenates commands for MPNN into batches so that MPNN does not have to be loaded individually for each PDB file.</span>

<span class="sd">        This method prepares the LigandMPNN commands for batch execution. It concatenates the commands into batches to optimize the running process by reducing the overhead of loading the MPNN model multiple times.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            cmds (list[str]): A list of commands to run LigandMPNN.</span>
<span class="sd">            num_batches (int): The number of batches to split the commands into.</span>
<span class="sd">            output_dir (str): The directory where the batch input JSON files will be saved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[str]: A list of concatenated batch commands.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Here is an example of how to use the `setup_batch_run` method:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                # Initialize the LigandMPNN class</span>
<span class="sd">                ligandmpnn = LigandMPNN()</span>

<span class="sd">                # Example commands</span>
<span class="sd">                cmds = [</span>
<span class="sd">                    &quot;/path/to/python /path/to/run.py --option1=value1 --pdb_path=path1.pdb&quot;,</span>
<span class="sd">                    &quot;/path/to/python /path/to/run.py --option2=value2 --pdb_path=path2.pdb&quot;,</span>
<span class="sd">                    # More commands...</span>
<span class="sd">                ]</span>

<span class="sd">                # Setup batch run</span>
<span class="sd">                batch_cmds = ligandmpnn.setup_batch_run(</span>
<span class="sd">                    cmds=cmds,</span>
<span class="sd">                    num_batches=2,</span>
<span class="sd">                    output_dir=&quot;/path/to/output&quot;</span>
<span class="sd">                )</span>

<span class="sd">                print(batch_cmds)  # Outputs the batch commands</span>

<span class="sd">        Further Details:</span>
<span class="sd">            - **Batch Command Setup:** The method splits the provided commands into sublists based on the number of batches. It then processes each sublist to handle multi-residue options and generate corresponding JSON files.</span>
<span class="sd">            - **JSON Directory:** The method sets up a directory for storing JSON files that contain mappings for multi-residue options.</span>
<span class="sd">            - **Command Concatenation:** Each command sublist is processed to extract and convert multi-residue options into JSON files, which are then referenced in the batch commands.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">multi_cols</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;omit_AA_per_residue&quot;</span><span class="p">:</span> <span class="s2">&quot;omit_AA_per_residue_multi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bias_AA_per_residue&quot;</span><span class="p">:</span> <span class="s2">&quot;bias_AA_per_residue_multi&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;redesigned_residues&quot;</span><span class="p">:</span> <span class="s2">&quot;redesigned_residues_multi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fixed_residues&quot;</span><span class="p">:</span> <span class="s2">&quot;fixed_residues_multi&quot;</span><span class="p">,</span> 
            <span class="s2">&quot;pdb_path&quot;</span><span class="p">:</span> <span class="s2">&quot;pdb_path_multi&quot;</span>
        <span class="p">}</span>
        <span class="c1"># setup json directory</span>
        <span class="n">json_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/input_json_files/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">json_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">json_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># split cmds list into n=num_batches sublists</span>
        <span class="n">cmd_sublists</span> <span class="o">=</span> <span class="n">protflow</span><span class="o">.</span><span class="n">jobstarters</span><span class="o">.</span><span class="n">split_list</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span> <span class="n">n_sublists</span><span class="o">=</span><span class="n">num_batches</span><span class="p">)</span>

        <span class="c1"># concatenate cmds: parse _multi arguments into .json files and keep all other arguments in options.</span>
        <span class="n">batch_cmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cmd_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cmd_sublists</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">full_cmd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">cmd_list</span><span class="p">]</span>
            <span class="n">opts_flags_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">regex_expand_options_flags</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd_split</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span> <span class="k">for</span> <span class="n">cmd_split</span> <span class="ow">in</span> <span class="n">full_cmd_list</span><span class="p">]</span>
            <span class="n">opts_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">opts_flags_list</span><span class="p">]</span> <span class="c1"># regex_expand_options_flags() returns (options, flags)</span>

            <span class="c1"># take first cmd for general options and flags</span>
            <span class="n">full_opts_flags</span> <span class="o">=</span> <span class="n">opts_flags_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cmd_start</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_cmd_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span> <span class="c1"># keep /path/to/python3 /path/to/run.py</span>

            <span class="c1"># extract lists for _multi options</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">multi_col</span> <span class="ow">in</span> <span class="n">multi_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># if col does not exist in options, skip:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="c1"># extract pdb-file to argument mapping as dictionary:</span>
                <span class="n">col_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">opts</span><span class="p">[</span><span class="s2">&quot;pdb_path&quot;</span><span class="p">]:</span> <span class="n">opts</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">opts</span> <span class="ow">in</span> <span class="n">opts_list</span><span class="p">}</span>

                <span class="c1"># write col_dict to json</span>
                <span class="n">col_json_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">json_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">col_json_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">col_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

                <span class="c1"># remove single option from full_opts_flags and set cmd_json file as _multi option:</span>
                <span class="k">del</span> <span class="n">full_opts_flags</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
                <span class="n">full_opts_flags</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">multi_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_json_path</span>

            <span class="c1"># reassemble command and put into batch_cmds</span>
            <span class="n">batch_cmd</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cmd_start</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">options_flags_to_string</span><span class="p">(</span><span class="o">*</span><span class="n">full_opts_flags</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">batch_cmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_cmd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">batch_cmds</span></div>


<div class="viewcode-block" id="LigandMPNN.parse_pose_opt_cols">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.parse_pose_opt_cols">[docs]</a>
    <span class="k">def</span> <span class="nf">parse_pose_opt_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">poses</span><span class="p">:</span> <span class="n">Poses</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pose_opt_cols</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses pose-specific options columns into pose options formatted strings.</span>

<span class="sd">        This method processes the `pose_opt_cols` dictionary and converts its contents into a format that can be used as part of the LigandMPNN pose options. It ensures that the options are properly structured and, if necessary, writes specific arguments into JSON files.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            poses (Poses): The Poses object containing the protein structures.</span>
<span class="sd">            output_dir (str): The directory where JSON files for multi-residue options will be saved.</span>
<span class="sd">            pose_opt_cols (dict, optional): Dictionary of pose-specific options for the LigandMPNN script. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[dict]: A list of dictionaries containing the parsed pose options formatted as strings.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If both fixed_residues and redesigned_residues are defined in pose_opt_cols, or if specified columns do not exist in poses.df.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Here is an example of how to use the `parse_pose_opt_cols` method:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                # Initialize the LigandMPNN class</span>
<span class="sd">                ligandmpnn = LigandMPNN()</span>

<span class="sd">                # Example Poses object and pose_opt_cols</span>
<span class="sd">                poses = Poses()</span>
<span class="sd">                pose_opt_cols = {</span>
<span class="sd">                    &quot;bias_AA_per_residue&quot;: &quot;bias_col&quot;,</span>
<span class="sd">                    &quot;fixed_residues&quot;: &quot;fixed_res_col&quot;</span>
<span class="sd">                }</span>

<span class="sd">                # Parse pose options</span>
<span class="sd">                parsed_opts = ligandmpnn.parse_pose_opt_cols(</span>
<span class="sd">                    poses=poses,</span>
<span class="sd">                    output_dir=&quot;/path/to/output&quot;,</span>
<span class="sd">                    pose_opt_cols=pose_opt_cols</span>
<span class="sd">                )</span>

<span class="sd">                print(parsed_opts)  # Outputs the parsed pose options</span>

<span class="sd">        Further Details:</span>
<span class="sd">            - **Option Parsing:** The method converts the `pose_opt_cols` dictionary into a list of strings formatted as pose options. It handles various types of options, including those that need to be written into JSON files and those that can be parsed directly from residue selections.</span>
<span class="sd">            - **JSON Directory Setup:** If necessary, the method sets up a directory for storing JSON files that contain mappings for multi-residue options.</span>
<span class="sd">            - **Error Handling:** The method includes checks to ensure that incompatible options are not specified simultaneously and that all specified columns exist in the poses DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return list of empty strings if pose_opts_col is None.</span>
        <span class="k">if</span> <span class="n">pose_opt_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">poses</span><span class="p">]</span>

        <span class="c1"># setup output_dir for .json files</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bias_AA_per_residue&quot;</span><span class="p">,</span> <span class="s2">&quot;omit_AA_per_residue&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pose_opt_cols</span><span class="p">]):</span>
            <span class="n">json_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/input_json_files/&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">json_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">json_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># check if fixed_residues and redesigned_residues were set properly (gets checked in LigandMPNN too, so maybe this is redundant.)</span>
        <span class="k">if</span> <span class="s2">&quot;fixed_residues&quot;</span> <span class="ow">in</span> <span class="n">pose_opt_cols</span> <span class="ow">and</span> <span class="s2">&quot;redesigned_residues&quot;</span> <span class="ow">in</span> <span class="n">pose_opt_cols</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot define both &lt;fixed_res_column&gt; and &lt;design_res_column&gt;!&quot;</span><span class="p">)</span>

        <span class="c1"># check if all specified columns exist in poses.df:</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pose_opt_cols</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">col_in_df</span><span class="p">(</span><span class="n">poses</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

        <span class="c1"># parse pose_options</span>
        <span class="n">pose_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pose</span> <span class="ow">in</span> <span class="n">poses</span><span class="p">:</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mpnn_arg</span><span class="p">,</span> <span class="n">mpnn_arg_col</span> <span class="ow">in</span> <span class="n">pose_opt_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># arguments that must be written into .json files:</span>
                <span class="k">if</span> <span class="n">mpnn_arg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bias_AA_per_residue&quot;</span><span class="p">,</span> <span class="s2">&quot;omit_AA_per_residue&quot;</span><span class="p">]:</span>
                    <span class="n">output_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">json_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mpnn_arg</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">pose</span><span class="p">[</span><span class="s1">&#39;poses_description&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.json&quot;</span>
                    <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">mpnn_arg</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">write_to_json</span><span class="p">(</span><span class="n">pose</span><span class="p">[</span><span class="n">mpnn_arg_col</span><span class="p">],</span><span class="w"> </span><span class="n">output_path</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># arguments that can be parsed as residues (from ResidueSelection objects):</span>
                <span class="k">elif</span> <span class="n">mpnn_arg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;redesigned_residues&quot;</span><span class="p">,</span> <span class="s2">&quot;fixed_residues&quot;</span><span class="p">,</span> <span class="s2">&quot;transmembrane_buried&quot;</span><span class="p">,</span> <span class="s2">&quot;transmembrane_interface&quot;</span><span class="p">]:</span>
                    <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">mpnn_arg</span><span class="si">}</span><span class="s2">=&#39;</span><span class="si">{</span><span class="n">parse_residues</span><span class="p">(</span><span class="n">pose</span><span class="p">[</span><span class="n">mpnn_arg_col</span><span class="p">])</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

                <span class="c1"># all other arguments:</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">opts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--</span><span class="si">{</span><span class="n">mpnn_arg</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">pose</span><span class="p">[</span><span class="n">mpnn_arg_col</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">pose_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">opts</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pose_options</span></div>


<div class="viewcode-block" id="LigandMPNN.write_cmd">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.write_cmd">[docs]</a>
    <span class="k">def</span> <span class="nf">write_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pose_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">nseq</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">pose_options</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the command to run ligandmpnn.py.</span>

<span class="sd">        This method constructs the command necessary to run the LigandMPNN script, incorporating various options and parameters. It ensures that the command is correctly formatted and includes all required arguments.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            pose_path (str): The path to the input PDB file for the pose.</span>
<span class="sd">            output_dir (str): The directory where the output files will be saved.</span>
<span class="sd">            model (str): The type of model to use (e.g., &quot;ligand_mpnn&quot;).</span>
<span class="sd">            nseq (int): The number of sequences to generate for each input pose. Defaults to 1.</span>
<span class="sd">            options (str): Additional options for the LigandMPNN script.</span>
<span class="sd">            pose_options (str): Pose-specific options for the LigandMPNN script.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The constructed command string to run LigandMPNN.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the specified model is not one of the available models.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Here is an example of how to use the `write_cmd` method:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                # Initialize the LigandMPNN class</span>
<span class="sd">                ligandmpnn = LigandMPNN()</span>

<span class="sd">                # Write the command</span>
<span class="sd">                cmd = ligandmpnn.write_cmd(</span>
<span class="sd">                    pose_path=&quot;path/to/input.pdb&quot;,</span>
<span class="sd">                    output_dir=&quot;path/to/output&quot;,</span>
<span class="sd">                    model=&quot;ligand_mpnn&quot;,</span>
<span class="sd">                    nseq=10,</span>
<span class="sd">                    options=&quot;some_option=some_value&quot;,</span>
<span class="sd">                    pose_options=&quot;pose_option=pose_value&quot;</span>
<span class="sd">                )</span>

<span class="sd">                print(cmd)  # Outputs the constructed command string</span>

<span class="sd">        Further Details:</span>
<span class="sd">            - **Model Validation:** The method checks if the specified model is among the available models and raises an error if it is not.</span>
<span class="sd">            - **Option Parsing:** The method parses generic options and pose-specific options, ensuring that necessary safety checks and defaults are applied.</span>
<span class="sd">            - **Command Construction:** The method assembles the final command string, including paths, model checkpoints, options, and other necessary parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># parse ligandmpnn_dir:</span>
        <span class="n">ligandmpnn_dir</span> <span class="o">=</span> <span class="n">protflow</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LIGANDMPNN_SCRIPT_PATH</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># check if specified model is correct.</span>
        <span class="n">available_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;protein_mpnn&quot;</span><span class="p">,</span> <span class="s2">&quot;ligand_mpnn&quot;</span><span class="p">,</span> <span class="s2">&quot;soluble_mpnn&quot;</span><span class="p">,</span> <span class="s2">&quot;global_label_membrane_mpnn&quot;</span><span class="p">,</span> <span class="s2">&quot;per_residue_label_membrane_mpnn&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> must be one of </span><span class="si">{</span><span class="n">available_models</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

        <span class="c1"># parse options</span>
        <span class="n">opts</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">parse_generic_options</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">pose_options</span><span class="p">)</span>

        <span class="c1"># safetychecks:</span>
        <span class="k">if</span> <span class="s2">&quot;model_type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;model_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span> <span class="ow">or</span> <span class="s2">&quot;ligand_mpnn&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;number_of_batches&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;number_of_batches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nseq</span> <span class="ow">or</span> <span class="s2">&quot;1&quot;</span>
        <span class="c1"># define model_checkpoint option:</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;checkpoint_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">model_checkpoint_options</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;--checkpoint_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">ligandmpnn_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">LIGANDMPNN_CHECKPOINT_DICT</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># safety</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting parse_atoms_with_zero_occupancy to 1 to ensure that the run does not crash.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;parse_atoms_with_zero_occupancy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;parse_atoms_with_zero_occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">elif</span> <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;parse_atoms_with_zero_occupancy&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
            <span class="n">opts</span><span class="p">[</span><span class="s2">&quot;parse_atoms_with_zero_occupancy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span>

        <span class="c1"># convert to string</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">options_flags_to_string</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>

        <span class="c1"># write command and return.</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">python_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">script_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">model_checkpoint_options</span><span class="si">}</span><span class="s2"> --out_folder </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/ --pdb_path </span><span class="si">{</span><span class="n">pose_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">options</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="LigandMPNN.collect_scores">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.LigandMPNN.collect_scores">[docs]</a>
    <span class="k">def</span> <span class="nf">collect_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">return_seq_threaded_pdbs_as_pose</span><span class="p">:</span><span class="nb">bool</span><span class="p">,</span> <span class="n">preserve_original_output</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collects scores from the LigandMPNN output.</span>

<span class="sd">        This method processes the output files generated by LigandMPNN, including multi-sequence FASTA files and PDB files. It reads, renames, and organizes these files into a structured DataFrame.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            work_dir (str): The directory where LigandMPNN output files are located.</span>
<span class="sd">            return_seq_threaded_pdbs_as_pose (bool): If True, replaces FASTA files with sequence-threaded PDB files as poses.</span>
<span class="sd">            preserve_original_output (bool, optional): If True, preserves the original output files. Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: A DataFrame containing the collected scores and relevant data from the LigandMPNN output.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If required output files are not found in the specified directory.</span>

<span class="sd">        Examples:</span>
<span class="sd">            Here is an example of how to use the `collect_scores` method:</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">                # Initialize the LigandMPNN class</span>
<span class="sd">                ligandmpnn = LigandMPNN()</span>

<span class="sd">                # Collect scores from the output directory</span>
<span class="sd">                scores = ligandmpnn.collect_scores(</span>
<span class="sd">                    work_dir=&quot;/path/to/output&quot;,</span>
<span class="sd">                    return_seq_threaded_pdbs_as_pose=True,</span>
<span class="sd">                    preserve_original_output=False</span>
<span class="sd">                )</span>

<span class="sd">                print(scores)  # Outputs the collected scores DataFrame</span>

<span class="sd">        Further Details:</span>
<span class="sd">            - **Output Processing:** The method reads and parses multi-sequence FASTA files, converts sequences into a structured dictionary, and writes new FASTA files if necessary.</span>
<span class="sd">            - **File Management:** Original output files are copied to dedicated directories, and new files are generated and organized for easy access. Optionally, original files can be preserved or deleted based on the `preserve_original_output` parameter.</span>
<span class="sd">            - **Error Handling:** The method includes checks to ensure that required output files are present, raising errors if files are missing or paths are incorrect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">mpnn_fastaparser</span><span class="p">(</span><span class="n">fasta_path</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;reads in ligandmpnn multi-sequence fasta, renames sequences and returns them&#39;&#39;&#39;</span>
            <span class="n">records</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Bio</span><span class="o">.</span><span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">fasta_path</span><span class="p">,</span> <span class="s2">&quot;fasta&quot;</span><span class="p">))</span>
            <span class="c1">#maxlength = len(str(len(records)))</span>

            <span class="c1"># Set continuous numerating for the names of mpnn output sequences:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">records</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">records</span>

        <span class="k">def</span> <span class="nf">convert_ligandmpnn_seqs_to_dict</span><span class="p">(</span><span class="n">seqs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Takes already parsed list of fastas as input &lt;seqs&gt;. Fastas can be parsed with the function mpnn_fastaparser(file).</span>
<span class="sd">            Should be put into list.</span>
<span class="sd">            Converts mpnn fastas into a dictionary:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;col_1&quot;: [vals]</span>
<span class="sd">                    ...</span>
<span class="sd">                &quot;col_n&quot;: [vals]</span>
<span class="sd">            }</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="c1"># Define cols and initiate them as empty lists:</span>
            <span class="n">seqs_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mpnn_origin&quot;</span><span class="p">,</span> <span class="s2">&quot;seed&quot;</span><span class="p">,</span> <span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;sequence&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;seq_rec&quot;</span><span class="p">,</span> <span class="s2">&quot;overall_confidence&quot;</span><span class="p">,</span> <span class="s2">&quot;ligand_confidence&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">seqs_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Read scores of each sequence in each file and append them to the corresponding columns:</span>
            <span class="k">for</span> <span class="n">seq</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">seqs_dict</span><span class="p">[</span><span class="s2">&quot;mpnn_origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">seqs_dict</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">seq</span><span class="p">))</span>
                    <span class="n">seqs_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]]}</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">seqs_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">seqs_dict</span>

        <span class="k">def</span> <span class="nf">write_mpnn_fastas</span><span class="p">(</span><span class="n">seqs_dict</span><span class="p">:</span><span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">seqs_dict</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">seqs_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span> <span class="n">seqs_dict</span><span class="p">[</span><span class="s2">&quot;sequence&quot;</span><span class="p">]):</span>
                <span class="n">seqs_dict</span><span class="p">[</span><span class="s2">&quot;location&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fa_file</span> <span class="o">:=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seq_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">.fa&quot;</span><span class="p">))</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fa_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&gt;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">seqs_dict</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rename_mpnn_pdb</span><span class="p">(</span><span class="n">pdb</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;changes single digit file extension to 4 digit file extension&#39;&#39;&#39;</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">pdb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">extension</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="si">}</span><span class="s2">.pdb&quot;</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># read .pdb files</span>
        <span class="n">seq_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;seqs&#39;</span><span class="p">)</span>
        <span class="n">pdb_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">work_dir</span><span class="p">,</span> <span class="s1">&#39;backbones&#39;</span><span class="p">)</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">seq_dir</span><span class="si">}</span><span class="s2">/*.fa&quot;</span><span class="p">)</span>
        <span class="n">pl</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pdb_dir</span><span class="si">}</span><span class="s2">/*.pdb&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fl</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No .fa files were found in the output directory of LigandMPNN </span><span class="si">{</span><span class="n">seq_dir</span><span class="si">}</span><span class="s2">. LigandMPNN might have crashed (check output log), or path might be wrong!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pl</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No .pdb files were found in the output directory of LigandMPNN </span><span class="si">{</span><span class="n">pdb_dir</span><span class="si">}</span><span class="s2">. LigandMPNN might have crashed (check output log), or path might be wrong!&quot;</span><span class="p">)</span>

        <span class="n">seqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpnn_fastaparser</span><span class="p">(</span><span class="n">fasta</span><span class="p">)</span> <span class="k">for</span> <span class="n">fasta</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">]</span>
        <span class="n">seqs_dict</span> <span class="o">=</span> <span class="n">convert_ligandmpnn_seqs_to_dict</span><span class="p">(</span><span class="n">seqs</span><span class="p">)</span>

        <span class="n">original_seqs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq_dir</span><span class="p">,</span> <span class="s1">&#39;original_seqs&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying original .fa files into directory </span><span class="si">{</span><span class="n">original_seqs_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">original_seqs_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">fasta</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_seqs_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fasta</span><span class="p">)))</span> <span class="k">for</span> <span class="n">fasta</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">]</span>

        <span class="n">original_pdbs_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pdb_dir</span><span class="p">,</span> <span class="s1">&#39;original_backbones&#39;</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copying original .pdb files into directory </span><span class="si">{</span><span class="n">original_pdbs_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">original_pdbs_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pdb</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">original_pdbs_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pdb</span><span class="p">)))</span> <span class="k">for</span> <span class="n">pdb</span> <span class="ow">in</span> <span class="n">pl</span><span class="p">]</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">rename_mpnn_pdb</span><span class="p">(</span><span class="n">pdb</span><span class="p">)</span> <span class="k">for</span> <span class="n">pdb</span> <span class="ow">in</span> <span class="n">pl</span><span class="p">]</span>

        <span class="c1"># Write new .fa files by iterating through &quot;description&quot; and &quot;sequence&quot; keys of the seqs_dict</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing new fastafiles at original location </span><span class="si">{</span><span class="n">seq_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">write_mpnn_fastas</span><span class="p">(</span><span class="n">seqs_dict</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_seq_threaded_pdbs_as_pose</span><span class="p">:</span>
            <span class="c1">#replace .fa with sequence threaded pdb files as poses</span>
            <span class="n">scores</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pdb_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">series</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">.pdb&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">scores</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">preserve_original_output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">original_seqs_dir</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting original .fa files at </span><span class="si">{</span><span class="n">original_seqs_dir</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">original_seqs_dir</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">original_pdbs_dir</span><span class="p">):</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting original .pdb files at </span><span class="si">{</span><span class="n">original_pdbs_dir</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">original_pdbs_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span></div>
</div>


<div class="viewcode-block" id="parse_residues">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.parse_residues">[docs]</a>
<span class="k">def</span> <span class="nf">parse_residues</span><span class="p">(</span><span class="n">residues</span><span class="p">:</span><span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parses residues from either ResidueSelection object, list, or MPNN-formatted string into MPNN-formatted string.</span>

<span class="sd">    This function converts the input residues into a format compatible with MPNN. It supports conversion from ResidueSelection objects, comma-separated strings, and lists of residues.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        residues (object): The input residues to be parsed. This can be a ResidueSelection object, a comma-separated string, or a list of residues.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The residues formatted as a string compatible with MPNN.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the input type is not supported (i.e., not a str or ResidueSelection).</span>

<span class="sd">    Examples:</span>
<span class="sd">        Here is an example of how to use the `parse_residues` function:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from protflow.residues import ResidueSelection</span>

<span class="sd">            # Example ResidueSelection object</span>
<span class="sd">            residues = ResidueSelection([&quot;A:10&quot;, &quot;A:20&quot;])</span>

<span class="sd">            # Parse residues</span>
<span class="sd">            parsed_residues = parse_residues(residues)</span>
<span class="sd">            print(parsed_residues)  # Outputs: &quot;A:10 A:20&quot;</span>

<span class="sd">            # Example string input</span>
<span class="sd">            residues_str = &quot;A:10,A:20&quot;</span>
<span class="sd">            parsed_residues = parse_residues(residues_str)</span>
<span class="sd">            print(parsed_residues)  # Outputs: &quot;A:10 A:20&quot;</span>

<span class="sd">    Further Details:</span>
<span class="sd">        - **ResidueSelection Object:** The function calls the `to_string` method of the ResidueSelection object to get the MPNN-formatted string.</span>
<span class="sd">        - **String Input:** For comma-separated string inputs, the function splits the string by commas and joins the parts with spaces.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ResidueSelection should have to_mpnn function.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="n">ResidueSelection</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">residues</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">delim</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

    <span class="c1"># strings:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">residues</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">residues</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">residues</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">residues</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Residues must be of type str or ResidueSelection. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">residues</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_to_json">
<a class="viewcode-back" href="../../../protflow.tools.html#protflow.tools.ligandmpnn.write_to_json">[docs]</a>
<span class="k">def</span> <span class="nf">write_to_json</span><span class="p">(</span><span class="n">input_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Writes json serializable :input_dict: into file and returns path to file. Returns path to json file :output_path:&#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output_path</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Your Name.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>